# UV Migration Guide (Temporary)

> **Note**: This is a temporary guide for the transition from Python 3.11 + conda/pip to Python 3.12 + uv. Once the migration is complete and server testing passes, this content will be integrated into the main `development.md` guide.

## Overview

We are migrating from:
- **Python 3.11** + **conda/pip** + `requirements.txt`

To:
- **Python 3.12** + **uv** + `pyproject.toml`

This guide helps developers transition their local development environment.

---

## Quick Comparison

| Task | Before (conda/pip) | After (uv) |
|------|-------------------|------------|
| Create environment | `conda create -n myenv python=3.11` | `uv sync --python 3.12` |
| Activate environment | `conda activate myenv` | Use `.venv/bin/python` or `uv run` |
| Install dependencies | `pip install -r requirements.txt` | `uv sync` |
| Run a script | `python script.py` | `uv run python script.py` |
| Run tests | `pytest` | `uv run pytest` |
| Add a package | `pip install package` | `uv add package` |

---

## Installing uv

### macOS / Linux

```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### macOS with Homebrew

```bash
brew install uv
```

### Verify installation

```bash
uv --version
```

---

## Setting Up a Module for Development

Each module now has a `pyproject.toml` file that defines its dependencies. Here's how to set up a module for local development:

### Step 1: Navigate to the module

```bash
cd apps/<module_name>
# Example: cd apps/preprocessing_runoff
```

### Step 2: Create virtual environment and install dependencies

```bash
uv sync --python 3.12
```

This creates a `.venv/` directory with Python 3.12 and all dependencies installed.

### Step 3: Run the module

**Option A: Using `uv run`** (recommended)
```bash
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run python <script>.py
```

**Option B: Using the venv directly**
```bash
ieasyhydroforecast_env_file_path=/path/to/config/.env .venv/bin/python <script>.py
```

### Step 4: Run tests

```bash
uv run pytest
# or
uv run pytest tests/ -v
```

---

## Module-Specific Examples

### preprocessing_runoff

```bash
cd apps/preprocessing_runoff
uv sync --python 3.12
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run python preprocessing_runoff.py
```

### preprocessing_gateway

The preprocessing_gateway module has multiple scripts:

```bash
cd apps/preprocessing_gateway
uv sync --python 3.12

# Download operational weather forecasts
SAPPHIRE_OPDEV_ENV=True ieasyhydroforecast_env_file_path=/path/to/config/.env \
  uv run python Quantile_Mapping_OP.py

# Extend ERA5 reanalysis data
SAPPHIRE_OPDEV_ENV=True ieasyhydroforecast_env_file_path=/path/to/config/.env \
  uv run python extend_era5_reanalysis.py

# Download operational snow data
SAPPHIRE_OPDEV_ENV=True ieasyhydroforecast_env_file_path=/path/to/config/.env \
  uv run python snow_data_operational.py

# Download ERA5 reanalysis for hindcasts (one-time initialization)
SAPPHIRE_OPDEV_ENV=True ieasyhydroforecast_reanalysis_START_DATE=2009-01-01 \
  ieasyhydroforecast_reanalysis_END_DATE=2023-12-31 \
  ieasyhydroforecast_env_file_path=/path/to/config/.env \
  uv run python get_era5_reanalysis_data.py
```

### linear_regression

```bash
cd apps/linear_regression
uv sync --python 3.12
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run python linear_regression.py
```

### machine_learning

```bash
cd apps/machine_learning
uv sync --python 3.12
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run python make_forecast.py
```

### postprocessing_forecasts

```bash
cd apps/postprocessing_forecasts
uv sync --python 3.12
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run python postprocessing_forecasts.py
```

### forecast_dashboard

```bash
cd apps/forecast_dashboard
uv sync --python 3.12
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run panel serve forecast_dashboard.py
```

### pipeline

```bash
cd apps/pipeline
uv sync --python 3.12
ieasyhydroforecast_env_file_path=/path/to/config/.env uv run python pipeline_docker.py
```

---

## Key Differences from Conda

### No activation needed

With uv, you don't need to "activate" an environment. Instead:
- Use `uv run <command>` to run commands in the virtual environment
- Or use `.venv/bin/python` directly

### Dependencies in pyproject.toml

Dependencies are now defined in `pyproject.toml` instead of `requirements.txt`:

```toml
[project]
dependencies = [
    "pandas>=2.2.2",
    "numpy>=1.26.4",
    # ...
]
```

### Lock files

Each module has a `uv.lock` file that pins exact versions. This ensures reproducible builds.

- **Don't edit `uv.lock` manually** — it's generated by `uv lock`
- **Commit `uv.lock`** to version control

### Adding new dependencies

```bash
# Add a package
uv add requests

# Add a dev dependency
uv add --dev pytest
```

This updates both `pyproject.toml` and `uv.lock`.

---

## Docker Images

### Image Tags

| Tag | Python | Package Manager | Status |
|-----|--------|-----------------|--------|
| `:latest` | 3.11 | pip | Production (until Phase 6) |
| `:py312` | 3.12 | uv | Testing/migration |
| `:py311` | 3.11 | pip | Archive (after Phase 6) |

### Testing with py312 images locally

```bash
# Pull the py312 image
docker pull mabesa/sapphire-preprunoff:py312

# Run with the new image
docker run --rm mabesa/sapphire-preprunoff:py312 python --version
# Expected: Python 3.12.x
```

### Building py312 images locally

From the repository root:

```bash
# Build base image
docker build -f apps/docker_base_image/Dockerfile.py312 -t mabesa/sapphire-pythonbaseimage:py312 .

# Build a module image
docker build -f apps/preprocessing_runoff/Dockerfile.py312 -t mabesa/sapphire-preprunoff:py312 .
```

---

## Troubleshooting

### "Command not found: uv"

Make sure uv is installed and in your PATH:
```bash
# Check if uv is installed
which uv

# If not found, reinstall
curl -LsSf https://astral.sh/uv/install.sh | sh

# Restart your terminal or run
source ~/.bashrc  # or ~/.zshrc
```

### "No Python 3.12 found"

uv can install Python for you:
```bash
uv python install 3.12
```

### Import errors after switching to uv

Make sure you're using the correct Python:
```bash
# This should show the .venv Python
uv run which python

# Verify imports
uv run python -c "import pandas; print(pandas.__version__)"
```

### Lock file conflicts

If you get lock file errors:
```bash
# Regenerate the lock file
uv lock

# Or upgrade all dependencies
uv lock --upgrade
```

### Permission errors in Docker

The py312 images run as root by default for compatibility with mounted volumes. If you need non-root:
```bash
docker run --user $(id -u):$(id -g) mabesa/sapphire-preprunoff:py312
```

---

## Migration Status

See `implementation_planning/uv_migration_plan.md` for the full migration status of each module.

**Current Status (2025-12-17):**
- All modules migrated to Python 3.12 + uv
- Server testing in progress
- Phase 6 (flip `:latest` to py312) pending successful server tests

---

## Questions?

If you encounter issues during the transition:
1. Check this guide and the troubleshooting section
2. Review `implementation_planning/uv_migration_plan.md` for detailed notes
3. Contact the development team

---

*Document created: 2025-12-17*
*This is a temporary guide — will be replaced by updated development.md after migration completes*
