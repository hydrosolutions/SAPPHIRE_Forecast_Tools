name: Quarterly Security Rebuild

# Rebuilds all Docker images from fresh upstream to pick up security fixes
# Runs quarterly or on-demand via manual trigger
# Uses Python 3.12 + uv workflow (aligned with deploy_main.yml)

on:
  schedule:
    # Run at 00:00 UTC on first day of Jan, Apr, Jul, Oct
    - cron: '0 0 1 1,4,7,10 *'
  workflow_dispatch:
    inputs:
      skip_module_rebuild:
        description: 'Rebuild only base image (skip module images)'
        type: boolean
        default: false

env:
  # Image names (same as deploy_main.yml)
  BASE_IMAGE_NAME: mabesa/sapphire-pythonbaseimage
  PIPELINE_IMAGE_NAME: mabesa/sapphire-pipeline
  DASHBOARD_IMAGE_NAME: mabesa/sapphire-dashboard
  PREPQ_IMAGE_NAME: mabesa/sapphire-preprunoff
  PREPG_IMAGE_NAME: mabesa/sapphire-prepgateway
  LINREG_IMAGE_NAME: mabesa/sapphire-linreg
  ML_IMAGE_NAME: mabesa/sapphire-ml
  POSTPQ_IMAGE_NAME: mabesa/sapphire-postprocessing
  # Deprecated/disabled images (kept for reference):
  # RERUN_IMAGE_NAME: mabesa/sapphire-rerun  # reset_forecast_run_date deprecated
  # CONCMOD_IMAGE_NAME: mabesa/sapphire-conceptmod  # R-based, builds broken

jobs:
  # Calculate quarterly tag (e.g., 2025-Q1)
  setup:
    runs-on: ubuntu-latest
    outputs:
      quarterly_tag: ${{ steps.calc.outputs.quarterly_tag }}
    steps:
      - name: Calculate quarterly tag
        id: calc
        run: |
          QUARTER=$(( ($(date +%-m) - 1) / 3 + 1 ))
          QUARTERLY_TAG="$(date +%Y)-Q${QUARTER}"
          echo "quarterly_tag=${QUARTERLY_TAG}" >> $GITHUB_OUTPUT
          echo "Quarterly tag: ${QUARTERLY_TAG}"

  # Test iEasyHydroForecast with Python 3.12 + uv before building base image
  test-base-image:
    needs: setup
    runs-on: ubuntu-latest
    name: Test iEasyHydroForecast (Python 3.12 + uv)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python 3.12 with uv
        run: uv python install 3.12

      - name: Install dependencies with uv
        working-directory: ./apps/iEasyHydroForecast
        run: |
          uv sync --all-extras

      - name: Test with pytest
        working-directory: ./apps
        run: |
          SAPPHIRE_TEST_ENV=True iEasyHydroForecast/.venv/bin/python -m pytest iEasyHydroForecast/tests/ -v

  # Build and push base image from fresh upstream with attestation
  rebuild-base-image:
    needs: [setup, test-base-image]
    runs-on: ubuntu-latest
    name: Rebuild base image from fresh upstream

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build with --pull to get fresh upstream base images (security updates)
      # Using --no-cache ensures all layers are rebuilt with latest packages
      - name: Build and push base image with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/docker_base_image/Dockerfile.py312
          push: true
          tags: |
            ${{ env.BASE_IMAGE_NAME }}:latest
            ${{ env.BASE_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          # Pull fresh base image to get security patches
          pull: true
          # Disable cache to ensure fresh build with latest packages
          no-cache: true
          # Enable SLSA provenance attestation
          provenance: true
          sbom: true

      - name: Verify base image
        run: |
          docker pull "${{ env.BASE_IMAGE_NAME }}:latest"
          echo "Verifying Python version..."
          docker run --rm "${{ env.BASE_IMAGE_NAME }}:latest" python --version
          echo "Verifying uv is available..."
          docker run --rm "${{ env.BASE_IMAGE_NAME }}:latest" uv --version
          echo "Pushed ${{ env.BASE_IMAGE_NAME }}:latest"
          echo "Pushed ${{ env.BASE_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}"

  # Rebuild all module images (only if not skipped)
  # Using matrix strategy with docker/build-push-action@v6

  rebuild-pipeline:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    name: Rebuild pipeline

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/pipeline/Dockerfile.py312
          push: true
          tags: |
            ${{ env.PIPELINE_IMAGE_NAME }}:latest
            ${{ env.PIPELINE_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  rebuild-dashboard:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    name: Rebuild forecast dashboard

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/forecast_dashboard/Dockerfile.py312
          push: true
          tags: |
            ${{ env.DASHBOARD_IMAGE_NAME }}:latest
            ${{ env.DASHBOARD_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  rebuild-preprunoff:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    name: Rebuild preprocessing runoff

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/preprocessing_runoff/Dockerfile.py312
          push: true
          tags: |
            ${{ env.PREPQ_IMAGE_NAME }}:latest
            ${{ env.PREPQ_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  rebuild-prepgateway:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    name: Rebuild preprocessing gateway

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/preprocessing_gateway/Dockerfile.py312
          push: true
          tags: |
            ${{ env.PREPG_IMAGE_NAME }}:latest
            ${{ env.PREPG_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  rebuild-linreg:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    name: Rebuild linear regression

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/linear_regression/Dockerfile.py312
          push: true
          tags: |
            ${{ env.LINREG_IMAGE_NAME }}:latest
            ${{ env.LINREG_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  rebuild-ml:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ML image is large, needs more time
    name: Rebuild machine learning

    steps:
      # Free disk space for large ML image (PyTorch/Darts)
      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/machine_learning/Dockerfile.py312
          push: true
          tags: |
            ${{ env.ML_IMAGE_NAME }}:latest
            ${{ env.ML_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  rebuild-postprocessing:
    needs: [setup, rebuild-base-image]
    if: ${{ github.event.inputs.skip_module_rebuild != 'true' }}
    runs-on: ubuntu-latest
    name: Rebuild postprocessing forecasts

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push with attestation
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/postprocessing_forecasts/Dockerfile.py312
          push: true
          tags: |
            ${{ env.POSTPQ_IMAGE_NAME }}:latest
            ${{ env.POSTPQ_IMAGE_NAME }}:${{ needs.setup.outputs.quarterly_tag }}
          pull: true
          no-cache: true
          provenance: true
          sbom: true

  # DISABLED: reset_forecast_run_date is deprecated
  # DISABLED: conceptual_model is R-based with broken dependencies

  # Generate summary
  summarize:
    needs:
      - setup
      - rebuild-base-image
      - rebuild-pipeline
      - rebuild-dashboard
      - rebuild-preprunoff
      - rebuild-prepgateway
      - rebuild-linreg
      - rebuild-ml
      - rebuild-postprocessing
    if: always()
    runs-on: ubuntu-latest
    name: Generate rebuild summary

    steps:
      - name: Generate summary
        run: |
          echo "# Quarterly Security Rebuild Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quarterly Tag:** ${{ needs.setup.outputs.quarterly_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Python version:** 3.12" >> $GITHUB_STEP_SUMMARY
          echo "- **Package manager:** uv" >> $GITHUB_STEP_SUMMARY
          echo "- **Dockerfile:** Dockerfile.py312" >> $GITHUB_STEP_SUMMARY
          echo "- **Fresh upstream:** yes (--pull --no-cache)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All images built with:" >> $GITHUB_STEP_SUMMARY
          echo "- SLSA provenance attestation" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM (Software Bill of Materials)" >> $GITHUB_STEP_SUMMARY
          echo "- Fresh upstream base images (security patches)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Images Rebuilt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | :latest | :${{ needs.setup.outputs.quarterly_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ env.BASE_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event.inputs.skip_module_rebuild }}" != "true" ]]; then
            echo "| ${{ env.PIPELINE_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
            echo "| ${{ env.DASHBOARD_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
            echo "| ${{ env.PREPQ_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
            echo "| ${{ env.PREPG_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
            echo "| ${{ env.LINREG_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
            echo "| ${{ env.ML_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
            echo "| ${{ env.POSTPQ_IMAGE_NAME }} | ✅ | ✅ |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Reproducibility" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To pin to this quarter's images, use:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`dockerfile" >> $GITHUB_STEP_SUMMARY
          echo "FROM mabesa/sapphire-pythonbaseimage:${{ needs.setup.outputs.quarterly_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
