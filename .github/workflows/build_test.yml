name: Test Build Docker Images

env:
  # Use a test tag to avoid conflicts with production images
  IMAGE_TAG: build-test

  # Define image names (same as in deploy_main.yml)
  BASE_IMAGE_NAME: mabesa/sapphire-pythonbaseimage
  PIPELINE_IMAGE_NAME: mabesa/sapphire-pipeline
  DASHBOARD_IMAGE_NAME: mabesa/sapphire-dashboard
  CONFIG_IMAGE_NAME: mabesa/sapphire-configuration
  PREPQ_IMAGE_NAME: mabesa/sapphire-preprunoff
  PREPG_IMAGE_NAME: mabesa/sapphire-prepgateway
  LINREG_IMAGE_NAME: mabesa/sapphire-linreg
  ML_IMAGE_NAME: mabesa/sapphire-ml
  POSTPQ_IMAGE_NAME: mabesa/sapphire-postprocessing
  RERUN_IMAGE_NAME: mabesa/sapphire-rerun
  CONCMOD_IMAGE_NAME: mabesa/sapphire-conceptmod

on:
  # Run on all branch pushes except main (which uses deploy_main.yml)
  push:
    branches-ignore:
      - main
  # Also run on PRs targeting main
  pull_request:
    branches:
      - main

jobs:
  # Test iEasyHydroForecast with Python 3.12 + uv + pytest
  test_ieasyhydroforecast:
    runs-on: ubuntu-latest
    name: Test iEasyHydroForecast

    steps:
    - name: Checkout the commit that triggered the workflow
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Set up Python 3.12 with uv
      run: uv python install 3.12

    - name: Install dependencies with uv
      working-directory: ./apps/iEasyHydroForecast
      run: |
        uv sync --all-extras

    - name: Test with pytest
      working-directory: ./apps
      run: |
        SAPPHIRE_TEST_ENV=True iEasyHydroForecast/.venv/bin/python -m pytest iEasyHydroForecast/tests/ -v

  # Build but don't push the Python 3.12 + uv base image
  build_base_image:
    needs: [test_ieasyhydroforecast]
    runs-on: ubuntu-latest
    name: Build Python 3.12 + uv base image
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build Docker image
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .
      - name: Test Base Image
        run: |
          echo "Verifying Python version..."
          docker run --rm "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" python --version
          echo "Verifying uv is available..."
          docker run --rm "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" uv --version
          # Note: py312 base image only provides Python + uv. Packages are installed by child images via uv sync.

  # Test pipeline with Python 3.12 + uv
  test_pipeline:
    runs-on: ubuntu-latest
    name: Test pipeline
    steps:
      - name: Check out the current branch
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python 3.12
        run: uv python install 3.12

      - name: Install pipeline dependencies
        working-directory: ./apps/pipeline
        run: uv sync --all-extras

      - name: Verify imports
        working-directory: ./apps
        run: |
          pipeline/.venv/bin/python -c "import luigi; import docker; import yaml; import requests; import tenacity; from dotenv import load_dotenv; print('All imports successful!'); print(f'luigi: {luigi.__version__}'); print(f'docker: {docker.__version__}')"

  # Build pipeline Python 3.12 + uv image
  build_pipeline:
    needs: [test_pipeline, build_base_image]
    runs-on: ubuntu-latest
    name: Build pipeline

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build base image first (required as dependency)
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .

      - name: Build Docker image
        run: |
          docker build \
          -t "${{ env.PIPELINE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/pipeline/Dockerfile.py312 .

  # DISABLED (2026-01-27): conceptual_model CI builds disabled - R dependencies broken
  # Module is maintenance-only. Existing Docker images frozen. See apps/conceptual_model/README.md
  # To re-enable: uncomment this job and add build_conceptual_model to summarize_builds.needs
  # build_conceptual_model:
  #   runs-on: ubuntu-latest
  #   name: Build conceptual model module
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Detect Docker group ID
  #       run: |
  #         DOCKER_GID=$(getent group docker | cut -d: -f3 || stat -c "%g" /var/run/docker.sock)
  #         echo "SAPPHIRE_DOCKER_GID=$DOCKER_GID" >> $GITHUB_ENV
  #     - name: Build Docker image
  #       run: |
  #         docker build \
  #         --build-arg USER_ID=1001 \
  #         --build-arg GROUP_ID=1001 \
  #         --build-arg SAPPHIRE_DOCKER_GID=${{ env.SAPPHIRE_DOCKER_GID }} \
  #         -t "${{ env.CONCMOD_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
  #         -f ./apps/conceptual_model/Dockerfile .

  # Test preprocessing runoff with Python 3.12 + uv
  test_preprocessing_runoff:
    runs-on: ubuntu-latest
    name: Test pre-processing of runoff

    steps:
    - name: Checkout the commit that triggered the workflow
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Set up Python 3.12 with uv
      run: uv python install 3.12

    - name: Set PYTHONPATH
      run: |
        echo "PYTHONPATH=${GITHUB_WORKSPACE}/apps:${GITHUB_WORKSPACE}/apps/iEasyHydroForecast" >> $GITHUB_ENV

    - name: Install dependencies with uv
      working-directory: ./apps/preprocessing_runoff
      run: |
        uv sync --all-extras

    - name: Test with pytest
      working-directory: ./apps
      run: |
        SAPPHIRE_TEST_ENV=True preprocessing_runoff/.venv/bin/python -m pytest preprocessing_runoff/test/ -v

  # Build the preprocessing runoff py312 image
  build_preprocessing_runoff:
    needs: [test_preprocessing_runoff, test_ieasyhydroforecast, build_base_image]
    runs-on: ubuntu-latest
    name: Build preprocessing runoff module
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build base image first (required as dependency)
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .
      - name: Build preprocessing runoff image
        run: |
          docker build \
          -t "${{ env.PREPQ_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/preprocessing_runoff/Dockerfile.py312 .

  # Test preprocessing gateway with Python 3.12 + uv
  test_preprocessing_gateway:
    runs-on: ubuntu-latest
    name: Test preprocessing gateway

    steps:
    - name: Checkout the commit that triggered the workflow
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Set up Python 3.12 with uv
      run: uv python install 3.12

    - name: Install dependencies with uv
      working-directory: ./apps/preprocessing_gateway
      run: |
        uv sync --all-extras

    - name: Verify imports
      working-directory: ./apps
      run: |
        preprocessing_gateway/.venv/bin/python -c "import pandas; import numpy; import scipy; import sklearn; import luigi; import sapphire_dg_client; print('All imports successful!')"

  # Build preprocessing gateway Python 3.12 + uv image
  build_preprocessing_gateway:
    needs: [test_preprocessing_gateway, build_base_image]
    runs-on: ubuntu-latest
    name: Build preprocessing gateway

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build base image first (required as dependency)
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .

      - name: Build Docker image
        run: |
          docker build \
          -t "${{ env.PREPG_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/preprocessing_gateway/Dockerfile.py312 .

  # Test machine learning with Python 3.12 + uv
  test_machine_learning:
    runs-on: ubuntu-latest
    name: Test machine learning
    steps:
      - name: Check out the current branch
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python 3.12
        run: uv python install 3.12

      - name: Install machine_learning dependencies
        working-directory: ./apps/machine_learning
        run: uv sync --all-extras

      - name: Verify imports
        working-directory: ./apps
        run: |
          machine_learning/.venv/bin/python -c "import torch; import darts; import pandas; import numpy; print('All imports successful!'); print(f'torch: {torch.__version__}'); print(f'darts: {darts.__version__}')"

  # Build machine learning Python 3.12 + uv image
  # Note: ML image is very large (~3-4GB) due to PyTorch/Darts, needs extra disk space
  build_machine_learning:
    needs: [test_machine_learning, build_base_image]
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Fail after 1 hour instead of default 6 hours
    name: Build machine learning

    steps:
      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build base image first (required as dependency)
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .

      - name: Build Docker image
        run: |
          docker build \
          -t "${{ env.ML_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/machine_learning/Dockerfile.py312 .

  # Test forecast dashboard with Python 3.12 + uv
  test_dashboard:
    runs-on: ubuntu-latest
    name: Test forecast dashboard
    steps:
      - name: Check out the current branch
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python 3.12
        run: uv python install 3.12

      - name: Install forecast_dashboard dependencies
        working-directory: ./apps/forecast_dashboard
        run: uv sync --all-extras

      - name: Verify imports
        working-directory: ./apps
        run: |
          forecast_dashboard/.venv/bin/python -c "import panel; import holoviews; import bokeh; import pandas; import numpy; import scipy; import sklearn; import docker; print('All imports successful!'); print(f'panel: {panel.__version__}'); print(f'bokeh: {bokeh.__version__}')"

  # Build forecast dashboard Python 3.12 + uv image
  build_dashboard:
    needs: [test_dashboard, build_base_image]
    runs-on: ubuntu-latest
    name: Build forecast dashboard

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build base image first (required as dependency)
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .

      - name: Build Docker image
        run: |
          docker build \
          -t "${{ env.DASHBOARD_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/forecast_dashboard/Dockerfile.py312 .

  # Test postprocessing with Python 3.12 + uv
  test_postprocessing:
    runs-on: ubuntu-latest
    name: Test postprocessing
    steps:
      - name: Check out the current branch
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python 3.12
        run: uv python install 3.12

      - name: Install postprocessing_forecasts dependencies
        working-directory: ./apps/postprocessing_forecasts
        run: uv sync --all-extras

      - name: Verify imports
        working-directory: ./apps
        run: |
          postprocessing_forecasts/.venv/bin/python -c "import pandas; import numpy; import openpyxl; print('All imports successful!')"

  # Build postprocessing Python 3.12 + uv image
  build_postprocessing:
    needs: [test_postprocessing, test_ieasyhydroforecast, build_base_image]
    runs-on: ubuntu-latest
    name: Build postprocessing

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build \
          -t "${{ env.POSTPQ_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/postprocessing_forecasts/Dockerfile.py312 .

  # Test linear regression with Python 3.12 + uv
  test_linear_regression:
    runs-on: ubuntu-latest
    name: Test linear regression
    steps:
      - name: Check out the current branch
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python 3.12
        run: uv python install 3.12

      - name: Install linear_regression dependencies
        working-directory: ./apps/linear_regression
        run: uv sync --all-extras

      - name: Verify imports
        working-directory: ./apps
        run: |
          linear_regression/.venv/bin/python -c "import pandas; import numpy; import docker; from ieasyhydro_sdk.sdk import IEasyHydroSDK, IEasyHydroHFSDK; print('All imports successful!')"

  # Build linear regression Python 3.12 + uv image
  build_linreg:
    needs: [test_linear_regression, build_base_image]
    runs-on: ubuntu-latest
    name: Build linear regression

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build base image first (required as dependency)
        run: |
          DOCKER_BUILDKIT=1 docker build \
          -t "${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/docker_base_image/Dockerfile.py312 .

      - name: Build Docker image
        run: |
          docker build \
          -t "${{ env.LINREG_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" \
          -f ./apps/linear_regression/Dockerfile.py312 .


  # Final job that summarizes all built images
  summarize_builds:
    needs: [
      build_base_image,
      build_pipeline,
      # build_conceptual_model,  # DISABLED: R dependencies broken
      build_preprocessing_runoff,
      build_preprocessing_gateway,
      build_machine_learning,
      build_dashboard,
      build_postprocessing,
      build_linreg
    ]
    runs-on: ubuntu-latest
    name: Summarize Docker image builds
    steps:
      - name: Generate summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully built the following Docker images:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Python 3.12 + uv" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.BASE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.PIPELINE_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.PREPQ_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.PREPG_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.ML_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.DASHBOARD_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.POSTPQ_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- ${{ env.LINREG_IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** These images were built for testing only and not pushed to DockerHub." >> $GITHUB_STEP_SUMMARY
